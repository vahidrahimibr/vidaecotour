<form [formGroup]="form">
  <!-- Multi-service selector with autocomplete -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Requested Services</mat-label>
    <input
      type="text"
      matInput
      placeholder="Type or select services"
      [formControl]="serviceInput"
      [matAutocomplete]="autoServices"
      (keydown.enter)="addServiceSelection(serviceInput.value ?? '')"
    />
    <mat-autocomplete
      #autoServices="matAutocomplete"
      (optionSelected)="addServiceSelection($event.option.value)"
    >
      <mat-option *ngFor="let type of filteredServices$ | async" [value]="type">
        {{ type }}
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>
  <!-- Show selected service chips -->
  <mat-chip-listbox>
    <mat-chip
      *ngFor="let service of selectedServices"
      color="primary"
      selected
      removable
      (removed)="removeService(service)"
    >
      {{ service }}
      <mat-icon matChipRemove>cancel</mat-icon>
    </mat-chip>
  </mat-chip-listbox>
  <!-- Placeholder blocks for selected services -->
  <div class="service-blocks">
    <div *ngIf="selectedServices.includes('Flights')" class="service-placeholder">
      âœˆï¸ Flights section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Transfer')" class="service-placeholder">
      ğŸš Transfer section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Accommodation')" class="service-placeholder">
      ğŸ¨ Accommodation section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Package')" class="service-placeholder">
      ğŸ Package section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Tour')" class="service-placeholder">
      ğŸŒ Tour section will appear here
    </div>
  </div>
  <!-- Dynamic Destination Hierarchy -->
  <div formArrayName="destinations" class="destination-section">
    <div
      *ngFor="let dest of destinations.controls; let i = index"
      [formGroupName]="i"
      class="destination-block"
    >
      <!-- Country selection with autocomplete -->
      <!-- Country selection with autocomplete + custom -->
      <div class="country-section">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Country</mat-label>
          <input
            type="text"
            matInput
            placeholder="Type or select countries"
            [formControlName]="'countryInput'"
            [matAutocomplete]="autoCountry"
            (keydown.enter)="addCountrySelection(dest.get('countryInput')?.value, i)"
          />
          <mat-autocomplete
            #autoCountry="matAutocomplete"
            (optionSelected)="addCountrySelection($event.option.value, i)"
          >
            <mat-option *ngFor="let country of filteredCountries$ | async" [value]="country">
              {{ country }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <!-- Selected countries as chips -->
        <mat-chip-listbox>
          <mat-chip
            *ngFor="let country of dest.value.countries"
            color="primary"
            selected
            removable
            (removed)="removeCountry(country, i)"
          >
            {{ country }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-listbox>
      </div>
      <!-- States selection (skip "Not listed") -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>State</mat-label>
        <mat-select multiple formControlName="states">
          <ng-container *ngFor="let country of dest.value.countries">
            <ng-container *ngIf="country !== 'Not listed'">
              <ng-container *ngFor="let state of getStates(country)">
                <mat-option [value]="state">{{ state }}</mat-option>
              </ng-container>
            </ng-container>
          </ng-container>
        </mat-select>
      </mat-form-field>

      <!-- Cities selection (skip "Not listed") -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>City</mat-label>
        <mat-select multiple formControlName="cities">
          <ng-container *ngFor="let country of dest.value.countries">
            <ng-container *ngIf="country !== 'Not listed'">
              <ng-container *ngFor="let state of dest.value.states">
                <ng-container *ngFor="let city of getCities(country, state)">
                  <mat-option [value]="city">{{ city }}</mat-option>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>
        </mat-select>
      </mat-form-field>
    </div>
  </div>
  <button mat-raised-button color="primary" (click)="onSubmit()">Next Step</button>
</form>
