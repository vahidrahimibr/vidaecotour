<form [formGroup]="form">
  <!-- Multi-service selector with autocomplete -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>Requested Services</mat-label>
    <input
      type="text"
      matInput
      placeholder="Type or select services"
      [formControl]="serviceInput"
      [matAutocomplete]="autoServices"
      (keydown.enter)="addServiceSelection(serviceInput.value ?? '')"
    />
    <mat-autocomplete
      #autoServices="matAutocomplete"
      (optionSelected)="addServiceSelection($event.option.value)"
    >
      <mat-option *ngFor="let type of filteredServices$ | async" [value]="type">
        {{ type }}
      </mat-option>
    </mat-autocomplete>
  </mat-form-field>
  <!-- Show selected service chips -->
  <mat-chip-listbox>
    <mat-chip
      *ngFor="let service of selectedServices"
      color="primary"
      selected
      removable
      (removed)="removeService(service)"
    >
      {{ service }}
      <mat-icon matChipRemove>cancel</mat-icon>
    </mat-chip>
  </mat-chip-listbox>
  <!-- Placeholder blocks for selected services -->
  <div class="service-blocks">
    <div *ngIf="selectedServices.includes('Flights')" class="service-placeholder">
      âœˆï¸ Flights section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Transfer')" class="service-placeholder">
      ğŸš Transfer section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Accommodation')" class="service-placeholder">
      ğŸ¨ Accommodation section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Package')" class="service-placeholder">
      ğŸ Package section will appear here
    </div>
    <div *ngIf="selectedServices.includes('Tour')" class="service-placeholder">
      ğŸŒ Tour section will appear here
    </div>
  </div>
  <!-- Dynamic Destination Hierarchy -->
  <div formArrayName="destinations" class="destination-section">
    <div
      *ngFor="let dest of destinations.controls; let i = index"
      [formGroupName]="i"
      class="destination-block"
    >
      <!-- Country Input + Chips -->
      <div class="country-section">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Country</mat-label>
          <input
            type="text"
            matInput
            placeholder="Add countries"
            [formControlName]="'countryInput'"
            [matAutocomplete]="autoCountry"
            (keydown.enter)="addCountrySelection(dest.get('countryInput')?.value, i)"
          />
          <mat-autocomplete
            #autoCountry="matAutocomplete"
            (optionSelected)="addCountrySelection($event.option.value, i)"
          >
            <mat-option *ngFor="let c of filteredCountries$ | async" [value]="c">
              {{ c }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <!-- Country Chips -->
        <mat-chip-listbox>
          <mat-chip
            *ngFor="let c of dest.value.countries"
            color="primary"
            selected
            removable
            (removed)="removeCountry(c, i)"
          >
            {{ c }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-listbox>
      </div>
      <!-- State Input + Chips (only show if countries exist) -->
      <div class="state-section" *ngIf="dest.value.countries?.length > 0">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>State / Region</mat-label>
          <input
            type="text"
            matInput
            placeholder="Add states"
            [formControlName]="'stateInput'"
            [matAutocomplete]="autoState"
            (keydown.enter)="addStateSelection(dest.get('stateInput')?.value, i)"
          />
          <mat-autocomplete
            #autoState="matAutocomplete"
            (optionSelected)="addStateSelection($event.option.value, i)"
          >
            <mat-option *ngFor="let s of filteredStates$ | async" [value]="s">
              {{ s }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-chip-listbox>
          <mat-chip
            *ngFor="let s of dest.value.states"
            color="accent"
            selected
            removable
            (removed)="removeState(s, i)"
          >
            {{ s }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-listbox>
      </div>

      <!-- Cities selection (skip "Not listed") -->
      <!-- City Input + Chips (only show if states exist) -->
      <div class="city-section" *ngIf="dest.value.states?.length > 0">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>City</mat-label>
          <input
            type="text"
            matInput
            placeholder="Add cities"
            [formControlName]="'cityInput'"
            [matAutocomplete]="autoCity"
            (keydown.enter)="addCitySelection(dest.get('cityInput')?.value, i)"
          />
          <mat-autocomplete
            #autoCity="matAutocomplete"
            (optionSelected)="addCitySelection($event.option.value, i)"
          >
            <mat-option *ngFor="let c of filteredCities$ | async" [value]="c">
              {{ c }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <mat-chip-listbox>
          <mat-chip
            *ngFor="let c of dest.value.cities"
            color="warn"
            selected
            removable
            (removed)="removeCity(c, i)"
          >
            {{ c }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-listbox>
      </div>
    </div>
  </div>
  <!-- Button to add another destination block -->
  <button mat-raised-button color="primary" (click)="onSubmit()">Next Step</button>
</form>
